<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">

<html lang="en">

    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>How To Emulate Persistent Memory using the Linux “memmap” Kernel Option | kb.pmem.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="How To Emulate Persistent Memory using the Linux “memmap” Kernel Option" />
<meta name="author" content="Steve Scargall" />
<meta property="og:locale" content="en" />
<meta name="description" content="Applies To This document applies to Linux distributions and versions that support persistent memory. Introduction The Linux pmem driver allows application developers to begin developing persistent memory enabled applications using memory mapped files residing on Direct Access Filesystems (DAX) such as EXT4 and XFS. A memmap kernel option was added that supports reserving one or more ranges of unassigned memory for use with emulated persistent memory. The memmap parameter documentation can be found at https://www.kernel.org/doc/Documentation/admin-guide/kernel-parameters.txt. This feature was available in the Linux Kernel v4.0. Kernel v4.15 introduced performance improvements and is recommended for production environments. On systems that do not have any physical persistent memory installed, emulating persistent memory allows for code development and functional testing. This approach is not recommended for storing critical data, performance testing, or benchmarking since it uses volatile DRAM. Any data written to the emulated persistent memory will be lost when the host reboots. The memmap kernel option uses the format of memmap=nn[KMG]!ss[KMG] ; where nn is the size of the region to reserve, ss is the starting offset, and [KMG] specifies the size in Kilobytes, Megabytes, or Gigabytes. The region of memory to be reserved is from ss to ss+nn. The memmap configuration option is passed to the Kernel using GRUB. Changing GRUB menu entries and kernel arguments varies between Linux distributions and potentially between versions of the same operating system distribution. Instructions for some of the common Linux distros can be found below. Refer to the documentation of the Linux distro and version being used for more information. Fedora Create a new memory mapping of 4GB starting at the 12GB boundary (ie from 12GB to 16GB) $ grubby --args=&quot;memmap=4G\!12G&quot; --update-kernel=ALL Reboot the host $ sudo systemctl reboot Ubuntu Create a new memory mapping of 4GB starting at the 12GB boundary (ie from 12GB to 16GB) $ sudo vi /etc/default/grub Add or edit the “GRUB_CMDLINE_LINUX” entry to include the mapping, eg: GRUB_CMDLINE_LINUX=&quot;memmap=4G!12G&quot; Update grub and reboot $ sudo update-grub2 $ sudo systemctl reboot RHEL &amp; CentOS Create a new memory mapping of 4GB starting at the 12GB boundary (ie from 12GB to 16GB) $ sudo vi /etc/default/grubGRUB_CMDLINE_LINUX=&quot;memmap=4G!12G&quot; Update the grub config $ sudo grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg Note: If more than one persistent memory namespace is required, specify a memmap entry for each namespace. For example, memmap=2G!12G memmap=2G!14G will create two 2GB namespaces, one using the 12GB-14GB memory address offset and the second using 14GB-16GB. After the host has been rebooted, a new /dev/pmem{N} device should exist, one for each memmap region specified in the GRUB config. These can be shown using ls /dev/pmem*. Naming convention starts at /dev/pmem0 and increments for each device. The /dev/pmem{N} devices can be used to create a DAX filesystem. Create and mount a filesystem using /dev/pmem device(s), then verify the dax flag is set for the mount point to confirm the DAX feature is enabled. The following shows how to create and mount an EXT4 or XFS filesystem. EXT4 $ sudo mkfs.ext4 /dev/pmem0 $ sudo mkdir /pmem $ sudo mount -o dax /dev/pmem0 /pmem $ sudo mount -v | grep /pmem /dev/pmem0 on /pmem type ext4 (rw,relatime,seclabel,dax,data=ordered) XFS $ sudo mkfs.xfs /dev/pmem0 $ sudo mkdir /pmem $ sudo mount -o dax /dev/pmem0 /pmem $ sudo mount -v | grep /pmem /dev/pmem0 on /pmem type xfs (rw,relatime,seclabel,attr2,dax,inode64,noquota) How To Choose the Correct memmap Option for Your System When selecting values for the memmap kernel parameter, consideration that the start and end addresses represent usable RAM must be made. Using or overlapping with reserved memory can result in corruption or undefined behavior. This information is easily available in the e820 table, available via dmesg. The following shows an example server with 16GiB of memory with “usable” memory between 4GiB (0x100000000) and ~16GiB (0x3ffffffff): $ dmesg | grep BIOS-e820 [ 0.000000] BIOS-e820: [mem 0x0000000000000000-0x000000000009fbff] usable [ 0.000000] BIOS-e820: [mem 0x000000000009fc00-0x000000000009ffff] reserved [ 0.000000] BIOS-e820: [mem 0x00000000000f0000-0x00000000000fffff] reserved [ 0.000000] BIOS-e820: [mem 0x0000000000100000-0x00000000bffdffff] usable [ 0.000000] BIOS-e820: [mem 0x00000000bffe0000-0x00000000bfffffff] reserved [ 0.000000] BIOS-e820: [mem 0x00000000feffc000-0x00000000feffffff] reserved [ 0.000000] BIOS-e820: [mem 0x00000000fffc0000-0x00000000ffffffff] reserved [ 0.000000] BIOS-e820: [mem 0x0000000100000000-0x00000003ffffffff] usable To reserve the 12GiB usable space between 4GiB and 16GiB as emulated persistent memory, the syntax for this reservation will be as follows: memmap=12G!4G After rebooting a new user defined e820 table entry shows the range is now “persistent (type 12)”: $ dmesg | grep user [ 0.000000] user: [mem 0x0000000000000000-0x000000000009fbff] usable [ 0.000000] user: [mem 0x000000000009fc00-0x000000000009ffff] reserved [ 0.000000] user: [mem 0x00000000000f0000-0x00000000000fffff] reserved [ 0.000000] user: [mem 0x0000000000100000-0x00000000bffdffff] usable [ 0.000000] user: [mem 0x00000000bffe0000-0x00000000bfffffff] reserved [ 0.000000] user: [mem 0x00000000feffc000-0x00000000feffffff] reserved [ 0.000000] user: [mem 0x00000000fffc0000-0x00000000ffffffff] reserved [ 0.000000] user: [mem 0x0000000100000000-0x00000003ffffffff] persistent (type 12) The fdisk or lsblk utilities can be used to show the capacity, eg: # sudo fdisk -l /dev/pmem0 Disk /dev/pmem0: 12 GiB, 12884901888 bytes, 25165824 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 4096 bytes I/O size (minimum/optimal): 4096 bytes / 4096 bytes $ sudo lsblk /dev/pmem0 NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT pmem0 259:0 0 12G 0 disk /pmem Note: Most Linux distributions ship with Kernel Address Space Layout Randomization (KASLR) enabled. This is defined by CONFIG_RANDOMIZE_BASE. When enabled, the Kernel may potentially use memory previously reserved for persistent memory without warning, resulting in corruption or undefined behavior. It is recommended to disable KASLR on systems with 16GiB or less. Refer to your Linux distribution documentation for details as the procedure varies per distro. Summary This article demonstrated how to emulate persistent memory using the Linux “memmap” kernel option on systems that do not have persistent memory physically installed. This emulation technique allows application developers to begin programming and testing code without needing access to physical persistent memory." />
<meta property="og:description" content="Applies To This document applies to Linux distributions and versions that support persistent memory. Introduction The Linux pmem driver allows application developers to begin developing persistent memory enabled applications using memory mapped files residing on Direct Access Filesystems (DAX) such as EXT4 and XFS. A memmap kernel option was added that supports reserving one or more ranges of unassigned memory for use with emulated persistent memory. The memmap parameter documentation can be found at https://www.kernel.org/doc/Documentation/admin-guide/kernel-parameters.txt. This feature was available in the Linux Kernel v4.0. Kernel v4.15 introduced performance improvements and is recommended for production environments. On systems that do not have any physical persistent memory installed, emulating persistent memory allows for code development and functional testing. This approach is not recommended for storing critical data, performance testing, or benchmarking since it uses volatile DRAM. Any data written to the emulated persistent memory will be lost when the host reboots. The memmap kernel option uses the format of memmap=nn[KMG]!ss[KMG] ; where nn is the size of the region to reserve, ss is the starting offset, and [KMG] specifies the size in Kilobytes, Megabytes, or Gigabytes. The region of memory to be reserved is from ss to ss+nn. The memmap configuration option is passed to the Kernel using GRUB. Changing GRUB menu entries and kernel arguments varies between Linux distributions and potentially between versions of the same operating system distribution. Instructions for some of the common Linux distros can be found below. Refer to the documentation of the Linux distro and version being used for more information. Fedora Create a new memory mapping of 4GB starting at the 12GB boundary (ie from 12GB to 16GB) $ grubby --args=&quot;memmap=4G\!12G&quot; --update-kernel=ALL Reboot the host $ sudo systemctl reboot Ubuntu Create a new memory mapping of 4GB starting at the 12GB boundary (ie from 12GB to 16GB) $ sudo vi /etc/default/grub Add or edit the “GRUB_CMDLINE_LINUX” entry to include the mapping, eg: GRUB_CMDLINE_LINUX=&quot;memmap=4G!12G&quot; Update grub and reboot $ sudo update-grub2 $ sudo systemctl reboot RHEL &amp; CentOS Create a new memory mapping of 4GB starting at the 12GB boundary (ie from 12GB to 16GB) $ sudo vi /etc/default/grubGRUB_CMDLINE_LINUX=&quot;memmap=4G!12G&quot; Update the grub config $ sudo grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg Note: If more than one persistent memory namespace is required, specify a memmap entry for each namespace. For example, memmap=2G!12G memmap=2G!14G will create two 2GB namespaces, one using the 12GB-14GB memory address offset and the second using 14GB-16GB. After the host has been rebooted, a new /dev/pmem{N} device should exist, one for each memmap region specified in the GRUB config. These can be shown using ls /dev/pmem*. Naming convention starts at /dev/pmem0 and increments for each device. The /dev/pmem{N} devices can be used to create a DAX filesystem. Create and mount a filesystem using /dev/pmem device(s), then verify the dax flag is set for the mount point to confirm the DAX feature is enabled. The following shows how to create and mount an EXT4 or XFS filesystem. EXT4 $ sudo mkfs.ext4 /dev/pmem0 $ sudo mkdir /pmem $ sudo mount -o dax /dev/pmem0 /pmem $ sudo mount -v | grep /pmem /dev/pmem0 on /pmem type ext4 (rw,relatime,seclabel,dax,data=ordered) XFS $ sudo mkfs.xfs /dev/pmem0 $ sudo mkdir /pmem $ sudo mount -o dax /dev/pmem0 /pmem $ sudo mount -v | grep /pmem /dev/pmem0 on /pmem type xfs (rw,relatime,seclabel,attr2,dax,inode64,noquota) How To Choose the Correct memmap Option for Your System When selecting values for the memmap kernel parameter, consideration that the start and end addresses represent usable RAM must be made. Using or overlapping with reserved memory can result in corruption or undefined behavior. This information is easily available in the e820 table, available via dmesg. The following shows an example server with 16GiB of memory with “usable” memory between 4GiB (0x100000000) and ~16GiB (0x3ffffffff): $ dmesg | grep BIOS-e820 [ 0.000000] BIOS-e820: [mem 0x0000000000000000-0x000000000009fbff] usable [ 0.000000] BIOS-e820: [mem 0x000000000009fc00-0x000000000009ffff] reserved [ 0.000000] BIOS-e820: [mem 0x00000000000f0000-0x00000000000fffff] reserved [ 0.000000] BIOS-e820: [mem 0x0000000000100000-0x00000000bffdffff] usable [ 0.000000] BIOS-e820: [mem 0x00000000bffe0000-0x00000000bfffffff] reserved [ 0.000000] BIOS-e820: [mem 0x00000000feffc000-0x00000000feffffff] reserved [ 0.000000] BIOS-e820: [mem 0x00000000fffc0000-0x00000000ffffffff] reserved [ 0.000000] BIOS-e820: [mem 0x0000000100000000-0x00000003ffffffff] usable To reserve the 12GiB usable space between 4GiB and 16GiB as emulated persistent memory, the syntax for this reservation will be as follows: memmap=12G!4G After rebooting a new user defined e820 table entry shows the range is now “persistent (type 12)”: $ dmesg | grep user [ 0.000000] user: [mem 0x0000000000000000-0x000000000009fbff] usable [ 0.000000] user: [mem 0x000000000009fc00-0x000000000009ffff] reserved [ 0.000000] user: [mem 0x00000000000f0000-0x00000000000fffff] reserved [ 0.000000] user: [mem 0x0000000000100000-0x00000000bffdffff] usable [ 0.000000] user: [mem 0x00000000bffe0000-0x00000000bfffffff] reserved [ 0.000000] user: [mem 0x00000000feffc000-0x00000000feffffff] reserved [ 0.000000] user: [mem 0x00000000fffc0000-0x00000000ffffffff] reserved [ 0.000000] user: [mem 0x0000000100000000-0x00000003ffffffff] persistent (type 12) The fdisk or lsblk utilities can be used to show the capacity, eg: # sudo fdisk -l /dev/pmem0 Disk /dev/pmem0: 12 GiB, 12884901888 bytes, 25165824 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 4096 bytes I/O size (minimum/optimal): 4096 bytes / 4096 bytes $ sudo lsblk /dev/pmem0 NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT pmem0 259:0 0 12G 0 disk /pmem Note: Most Linux distributions ship with Kernel Address Space Layout Randomization (KASLR) enabled. This is defined by CONFIG_RANDOMIZE_BASE. When enabled, the Kernel may potentially use memory previously reserved for persistent memory without warning, resulting in corruption or undefined behavior. It is recommended to disable KASLR on systems with 16GiB or less. Refer to your Linux distribution documentation for details as the procedure varies per distro. Summary This article demonstrated how to emulate persistent memory using the Linux “memmap” kernel option on systems that do not have persistent memory physically installed. This emulation technique allows application developers to begin programming and testing code without needing access to physical persistent memory." />
<link rel="canonical" href="https://kb.pmem.io/howto/100000012-How-To-Emulate-Persistent-Memory-using-the-Linux-memmapKernel-Option/" />
<meta property="og:url" content="https://kb.pmem.io/howto/100000012-How-To-Emulate-Persistent-Memory-using-the-Linux-memmapKernel-Option/" />
<meta property="og:site_name" content="kb.pmem.io" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-30T21:27:55+00:00" />
<script type="application/ld+json">
{"dateModified":"2020-03-30T21:27:55+00:00","datePublished":"2020-03-30T21:27:55+00:00","description":"Applies To This document applies to Linux distributions and versions that support persistent memory. Introduction The Linux pmem driver allows application developers to begin developing persistent memory enabled applications using memory mapped files residing on Direct Access Filesystems (DAX) such as EXT4 and XFS. A memmap kernel option was added that supports reserving one or more ranges of unassigned memory for use with emulated persistent memory. The memmap parameter documentation can be found at https://www.kernel.org/doc/Documentation/admin-guide/kernel-parameters.txt. This feature was available in the Linux Kernel v4.0. Kernel v4.15 introduced performance improvements and is recommended for production environments. On systems that do not have any physical persistent memory installed, emulating persistent memory allows for code development and functional testing. This approach is not recommended for storing critical data, performance testing, or benchmarking since it uses volatile DRAM. Any data written to the emulated persistent memory will be lost when the host reboots. The memmap kernel option uses the format of memmap=nn[KMG]!ss[KMG] ; where nn is the size of the region to reserve, ss is the starting offset, and [KMG] specifies the size in Kilobytes, Megabytes, or Gigabytes. The region of memory to be reserved is from ss to ss+nn. The memmap configuration option is passed to the Kernel using GRUB. Changing GRUB menu entries and kernel arguments varies between Linux distributions and potentially between versions of the same operating system distribution. Instructions for some of the common Linux distros can be found below. Refer to the documentation of the Linux distro and version being used for more information. Fedora Create a new memory mapping of 4GB starting at the 12GB boundary (ie from 12GB to 16GB) $ grubby --args=&quot;memmap=4G\\!12G&quot; --update-kernel=ALL Reboot the host $ sudo systemctl reboot Ubuntu Create a new memory mapping of 4GB starting at the 12GB boundary (ie from 12GB to 16GB) $ sudo vi /etc/default/grub Add or edit the “GRUB_CMDLINE_LINUX” entry to include the mapping, eg: GRUB_CMDLINE_LINUX=&quot;memmap=4G!12G&quot; Update grub and reboot $ sudo update-grub2 $ sudo systemctl reboot RHEL &amp; CentOS Create a new memory mapping of 4GB starting at the 12GB boundary (ie from 12GB to 16GB) $ sudo vi /etc/default/grubGRUB_CMDLINE_LINUX=&quot;memmap=4G!12G&quot; Update the grub config $ sudo grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg Note: If more than one persistent memory namespace is required, specify a memmap entry for each namespace. For example, memmap=2G!12G memmap=2G!14G will create two 2GB namespaces, one using the 12GB-14GB memory address offset and the second using 14GB-16GB. After the host has been rebooted, a new /dev/pmem{N} device should exist, one for each memmap region specified in the GRUB config. These can be shown using ls /dev/pmem*. Naming convention starts at /dev/pmem0 and increments for each device. The /dev/pmem{N} devices can be used to create a DAX filesystem. Create and mount a filesystem using /dev/pmem device(s), then verify the dax flag is set for the mount point to confirm the DAX feature is enabled. The following shows how to create and mount an EXT4 or XFS filesystem. EXT4 $ sudo mkfs.ext4 /dev/pmem0 $ sudo mkdir /pmem $ sudo mount -o dax /dev/pmem0 /pmem $ sudo mount -v | grep /pmem /dev/pmem0 on /pmem type ext4 (rw,relatime,seclabel,dax,data=ordered) XFS $ sudo mkfs.xfs /dev/pmem0 $ sudo mkdir /pmem $ sudo mount -o dax /dev/pmem0 /pmem $ sudo mount -v | grep /pmem /dev/pmem0 on /pmem type xfs (rw,relatime,seclabel,attr2,dax,inode64,noquota) How To Choose the Correct memmap Option for Your System When selecting values for the memmap kernel parameter, consideration that the start and end addresses represent usable RAM must be made. Using or overlapping with reserved memory can result in corruption or undefined behavior. This information is easily available in the e820 table, available via dmesg. The following shows an example server with 16GiB of memory with “usable” memory between 4GiB (0x100000000) and ~16GiB (0x3ffffffff): $ dmesg | grep BIOS-e820 [ 0.000000] BIOS-e820: [mem 0x0000000000000000-0x000000000009fbff] usable [ 0.000000] BIOS-e820: [mem 0x000000000009fc00-0x000000000009ffff] reserved [ 0.000000] BIOS-e820: [mem 0x00000000000f0000-0x00000000000fffff] reserved [ 0.000000] BIOS-e820: [mem 0x0000000000100000-0x00000000bffdffff] usable [ 0.000000] BIOS-e820: [mem 0x00000000bffe0000-0x00000000bfffffff] reserved [ 0.000000] BIOS-e820: [mem 0x00000000feffc000-0x00000000feffffff] reserved [ 0.000000] BIOS-e820: [mem 0x00000000fffc0000-0x00000000ffffffff] reserved [ 0.000000] BIOS-e820: [mem 0x0000000100000000-0x00000003ffffffff] usable To reserve the 12GiB usable space between 4GiB and 16GiB as emulated persistent memory, the syntax for this reservation will be as follows: memmap=12G!4G After rebooting a new user defined e820 table entry shows the range is now “persistent (type 12)”: $ dmesg | grep user [ 0.000000] user: [mem 0x0000000000000000-0x000000000009fbff] usable [ 0.000000] user: [mem 0x000000000009fc00-0x000000000009ffff] reserved [ 0.000000] user: [mem 0x00000000000f0000-0x00000000000fffff] reserved [ 0.000000] user: [mem 0x0000000000100000-0x00000000bffdffff] usable [ 0.000000] user: [mem 0x00000000bffe0000-0x00000000bfffffff] reserved [ 0.000000] user: [mem 0x00000000feffc000-0x00000000feffffff] reserved [ 0.000000] user: [mem 0x00000000fffc0000-0x00000000ffffffff] reserved [ 0.000000] user: [mem 0x0000000100000000-0x00000003ffffffff] persistent (type 12) The fdisk or lsblk utilities can be used to show the capacity, eg: # sudo fdisk -l /dev/pmem0 Disk /dev/pmem0: 12 GiB, 12884901888 bytes, 25165824 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 4096 bytes I/O size (minimum/optimal): 4096 bytes / 4096 bytes $ sudo lsblk /dev/pmem0 NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT pmem0 259:0 0 12G 0 disk /pmem Note: Most Linux distributions ship with Kernel Address Space Layout Randomization (KASLR) enabled. This is defined by CONFIG_RANDOMIZE_BASE. When enabled, the Kernel may potentially use memory previously reserved for persistent memory without warning, resulting in corruption or undefined behavior. It is recommended to disable KASLR on systems with 16GiB or less. Refer to your Linux distribution documentation for details as the procedure varies per distro. Summary This article demonstrated how to emulate persistent memory using the Linux “memmap” kernel option on systems that do not have persistent memory physically installed. This emulation technique allows application developers to begin programming and testing code without needing access to physical persistent memory.","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://kb.pmem.io/howto/100000012-How-To-Emulate-Persistent-Memory-using-the-Linux-memmapKernel-Option/"},"author":{"@type":"Person","name":"Steve Scargall"},"url":"https://kb.pmem.io/howto/100000012-How-To-Emulate-Persistent-Memory-using-the-Linux-memmapKernel-Option/","headline":"How To Emulate Persistent Memory using the Linux “memmap” Kernel Option","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="shortcut icon" type="image/png" href="/uploads/favicon.png" >
  <link rel="alternate" type="application/rss+xml" title="kb.pmem.io" href="/feed.xml">
  <script src="/assets/js/main.js"></script>
  
  
</head>


    <body>

    
        <div data-uk-sticky="animation: uk-animation-slide-top; sel-target: .uk-navbar-container; cls-active: uk-navbar-sticky; cls-inactive: uk-navbar-transparent; top: 200">
    <nav class="uk-navbar-container">
        <div class="uk-container">
            <div data-uk-navbar>
                <div class="uk-navbar-left">
                    <a class="uk-navbar-item uk-logo uk-visible@m" href="/">kb.pmem.io</a>
                    
                        <a class="uk-navbar-toggle uk-hidden@m" href="#offcanvas-docs" data-uk-toggle><span data-uk-navbar-toggle-icon></span> <span class="uk-margin-small-left">Docs</span></a>
                    

                    <ul class="uk-navbar-nav uk-visible@m">
                        
                            
                            
                            
                                
                                    
                                        <li><a href="/" >Home</a></li>
                                                                                                        
                                
                            
                        
                            
                            
                            
                                
                                    
                                        <li><a href="#">Knowledge Base</a>
                                        
                                            <div class="uk-navbar-dropdown">
                                                <ul class="uk-nav uk-navbar-dropdown-nav">
                                                    
                                                    
                                                        
                                                        
                                                        <li><a href="/development/">Development</a></li>
                                                    
                                                    
                                                    
                                                        
                                                        
                                                        <li><a href="/problem/">Problem Resolution</a></li>
                                                    
                                                    
                                                    
                                                        
                                                        
                                                        <li><a href="/howto/">How To</a></li>
                                                    
                                                    
                                                    
                                                        
                                                        
                                                        <li><a href="/faq/">Frequently Asked Questions</a></li>
                                                    
                                                    
                                                    
                                                        
                                                        
                                                        <li><a href="/apps/">Applications</a></li>
                                                    
                                                    
                                                </ul>
                                            </div>
                                        
                                        </li>
                                                                                                        
                                
                            
                        
                            
                            
                            
                                
                                    
                                        <li><a href="https://docs.pmem.io/" target="_blank" >Documentation</a></li>
                                                                                                        
                                
                            
                        
                            
                            
                            
                                
                                    
                                        <li><a href="https://pmem.io/blog/" target="_blank" >Blog</a></li>
                                                                                                        
                                
                            
                        
                    </ul>
                </div>
                <div class="uk-navbar-center uk-hidden@m">
                    <a class="uk-navbar-item uk-logo" href="/">kb.pmem.io</a>
                </div>
                <div class="uk-navbar-right">
                    
                        
                            <div>
				<script async src="https://cse.google.com/cse.js?cx=013996151090288251857:odeztdey5mo"></script>
				<a class="uk-navbar-toggle" uk-search-icon href="#"></a>
            			<div class="uk-drop" uk-drop="mode: click; pos: left-center; offset: 0">
                	  	    <form method="GET" action="/search" class="uk-search uk-search-navbar uk-width-1-1">
                    			<input id="minisearch" name="q" class="uk-search-input uk-border-radius-vlarge uk-box-shadow-medium gcse-searchbox-only" type="search" placeholder="Search..." autofocus>
                		    </form>
            			</div>
                            </div>
                        
                    

                    <ul class="uk-navbar-nav uk-visible@m">
                        
                    </ul>

                    
                        <a class="uk-navbar-toggle uk-hidden@m" href="#offcanvas" data-uk-toggle><span data-uk-navbar-toggle-icon></span> <span class="uk-margin-small-left">Menu</span></a>
                    

                </div>
            </div>
        </div>
    </nav>
</div>

    

    <div class="uk-section">
    <div class="uk-container">
        <article class="uk-article">

            <h1 class="uk-article-title">How To Emulate Persistent Memory using the Linux &quot;memmap&quot; Kernel Option</h1>

            <div class="article-content link-primary">
                <h3 id="applies-to">Applies To</h3>

<p>This document applies to Linux distributions and versions that support persistent memory.</p>

<h2 id="introduction">Introduction</h2>

<p>The Linux <code class="language-plaintext highlighter-rouge">pmem</code> driver allows application developers to begin developing persistent memory enabled applications using memory mapped files residing on Direct Access Filesystems (DAX) such as EXT4 and XFS.  A <code class="language-plaintext highlighter-rouge">memmap</code> kernel option was added that supports reserving one or more ranges of unassigned memory for use with emulated persistent memory.   The <code class="language-plaintext highlighter-rouge">memmap</code> parameter documentation can be found at <a href="https://www.kernel.org/doc/Documentation/admin-guide/kernel-parameters.txt">https://www.kernel.org/doc/Documentation/admin-guide/kernel-parameters.txt</a>.  This feature was available in the Linux Kernel v4.0.  Kernel v4.15 introduced performance improvements and is recommended for production environments.</p>

<p>On systems that do not have any physical persistent memory installed, emulating persistent memory allows for code development and functional testing.  This approach is not recommended for storing critical data, performance testing, or benchmarking since it uses volatile DRAM.  Any data written to the emulated persistent memory will be lost when the host reboots.</p>

<p>The memmap kernel option uses the format of <code class="language-plaintext highlighter-rouge">memmap=nn[KMG]!ss[KMG]</code> ; where <code class="language-plaintext highlighter-rouge">nn</code> is the size of the region to reserve, <code class="language-plaintext highlighter-rouge">ss</code> is the starting offset, and <code class="language-plaintext highlighter-rouge">[KMG]</code> specifies the size in Kilobytes, Megabytes, or Gigabytes.  The region of memory to be reserved is from ss to ss+nn.  The memmap configuration option is passed to the Kernel using GRUB.   Changing GRUB menu entries and kernel arguments varies between Linux distributions and potentially between versions of the same operating system distribution.  Instructions for some of the common Linux distros can be found below.  Refer to the documentation of the Linux distro and version being used for more information.</p>

<h3 id="fedora">Fedora</h3>

<p>Create a new memory mapping of 4GB starting at the 12GB boundary (ie from 12GB to 16GB)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ grubby --args="memmap=4G\!12G" --update-kernel=ALL
</code></pre></div></div>

<p>Reboot the host</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo systemctl reboot
</code></pre></div></div>

<h3 id="ubuntu">Ubuntu</h3>

<p>Create a new memory mapping of 4GB starting at the 12GB boundary (ie from 12GB to 16GB)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo vi /etc/default/grub
</code></pre></div></div>

<p>Add or edit the “GRUB_CMDLINE_LINUX” entry to include the mapping, eg:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GRUB_CMDLINE_LINUX="memmap=4G!12G"
</code></pre></div></div>

<p>Update grub and reboot</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo update-grub2
$ sudo systemctl reboot
</code></pre></div></div>

<h3 id="rhel--centos">RHEL &amp; CentOS</h3>

<p>Create a new memory mapping of 4GB starting at the 12GB boundary (ie from 12GB to 16GB)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo vi /etc/default/grubGRUB_CMDLINE_LINUX="memmap=4G!12G"
</code></pre></div></div>

<p>Update the grub config</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg
</code></pre></div></div>

<p><strong>Note:</strong> If more than one persistent memory namespace is required, specify a memmap entry for each namespace.  For example, <code class="language-plaintext highlighter-rouge">memmap=2G!12G memmap=2G!14G</code> will create two 2GB namespaces, one using the 12GB-14GB memory address offset and the second using 14GB-16GB.</p>

<p>After the host has been rebooted, a new <code class="language-plaintext highlighter-rouge">/dev/pmem{N}</code> device should exist, one for each memmap region specified in the GRUB config.  These can be shown using <code class="language-plaintext highlighter-rouge">ls /dev/pmem*</code>. Naming convention starts at <code class="language-plaintext highlighter-rouge">/dev/pmem0</code> and increments for each device.  The <code class="language-plaintext highlighter-rouge">/dev/pmem{N}</code> devices can be used to create a DAX filesystem.</p>

<p>Create and mount a filesystem using /dev/pmem device(s), then verify the <code class="language-plaintext highlighter-rouge">dax</code> flag is set for the mount point to confirm the DAX feature is enabled.  The following shows how to create and mount an EXT4 or XFS filesystem.</p>

<h3 id="ext4">EXT4</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo mkfs.ext4 /dev/pmem0
$ sudo mkdir /pmem
$ sudo mount -o dax /dev/pmem0 /pmem
$ sudo mount -v | grep /pmem
/dev/pmem0 on /pmem type ext4 (rw,relatime,seclabel,dax,data=ordered)
</code></pre></div></div>

<h3 id="xfs">XFS</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo mkfs.xfs /dev/pmem0
$ sudo mkdir /pmem
$ sudo mount -o dax /dev/pmem0 /pmem
$ sudo mount -v | grep /pmem
/dev/pmem0 on /pmem type xfs (rw,relatime,seclabel,attr2,dax,inode64,noquota)
</code></pre></div></div>

<h2 id="how-to-choose-the-correct-memmap-option-for-your-system">How To Choose the Correct memmap Option for Your System</h2>

<p>When selecting values for the <code class="language-plaintext highlighter-rouge">memmap</code> kernel parameter, consideration that the start and end addresses represent usable RAM must be made. Using or overlapping with reserved memory can result in corruption or undefined behavior. This information is easily available in the e820 table, available via dmesg.</p>

<p>The following shows an example server with 16GiB of memory with “usable” memory between 4GiB (0x100000000) and ~16GiB (0x3ffffffff):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dmesg | grep BIOS-e820
[    0.000000] BIOS-e820: [mem 0x0000000000000000-0x000000000009fbff] usable
[    0.000000] BIOS-e820: [mem 0x000000000009fc00-0x000000000009ffff] reserved
[    0.000000] BIOS-e820: [mem 0x00000000000f0000-0x00000000000fffff] reserved
[    0.000000] BIOS-e820: [mem 0x0000000000100000-0x00000000bffdffff] usable
[    0.000000] BIOS-e820: [mem 0x00000000bffe0000-0x00000000bfffffff] reserved
[    0.000000] BIOS-e820: [mem 0x00000000feffc000-0x00000000feffffff] reserved
[    0.000000] BIOS-e820: [mem 0x00000000fffc0000-0x00000000ffffffff] reserved
[    0.000000] BIOS-e820: [mem 0x0000000100000000-0x00000003ffffffff] usable
</code></pre></div></div>

<p>To reserve the 12GiB usable space between 4GiB and 16GiB as emulated persistent memory, the syntax for this reservation will be as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>memmap=12G!4G
</code></pre></div></div>

<p>After rebooting a new user defined e820 table entry shows the range is now “persistent (type 12)”:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dmesg | grep user
[    0.000000] user: [mem 0x0000000000000000-0x000000000009fbff] usable
[    0.000000] user: [mem 0x000000000009fc00-0x000000000009ffff] reserved
[    0.000000] user: [mem 0x00000000000f0000-0x00000000000fffff] reserved
[    0.000000] user: [mem 0x0000000000100000-0x00000000bffdffff] usable
[    0.000000] user: [mem 0x00000000bffe0000-0x00000000bfffffff] reserved
[    0.000000] user: [mem 0x00000000feffc000-0x00000000feffffff] reserved
[    0.000000] user: [mem 0x00000000fffc0000-0x00000000ffffffff] reserved
[    0.000000] user: [mem 0x0000000100000000-0x00000003ffffffff] persistent (type 12)
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">fdisk</code> or <code class="language-plaintext highlighter-rouge">lsblk</code> utilities can be used to show the capacity, eg:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sudo fdisk -l /dev/pmem0 
Disk /dev/pmem0: 12 GiB,  12884901888 bytes, 25165824 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 4096 bytes
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo lsblk /dev/pmem0
NAME  MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
pmem0 259:0    0  12G  0 disk /pmem
</code></pre></div></div>

<p><strong>Note:</strong> Most Linux distributions ship with Kernel Address Space Layout Randomization (KASLR) enabled. This is defined by <code class="language-plaintext highlighter-rouge">CONFIG_RANDOMIZE_BASE</code>.  When enabled, the Kernel may potentially use memory previously reserved for persistent memory without warning, resulting in corruption or undefined behavior.  It is recommended to disable KASLR on systems with 16GiB or less.  Refer to your Linux distribution documentation for details as the procedure varies per distro.</p>

<h2 id="summary">Summary</h2>

<p>This article demonstrated how to emulate persistent memory using the Linux “memmap” kernel option on systems that do not have persistent memory physically installed.  This emulation technique allows application developers to begin programming and testing code without needing access to physical persistent memory.</p>

            </div>

	    <div class="article-meta">
	        <h5>Disclaimer</h5>
<div class="disclaimer" id="disclaimer">
  <p> This Support Knowledgebase provides a valuable tool for parties interested in persistent memory products and solutions to acquire information, ideas and learn from one another. Materials are provided for informational, personal, commerical, and non-commercial use and are presented "AS IS" WITHOUT WARRANTY OF ANY KIND.
</div>



<h5>Document ID</h5>
100000012



<h5>Creation Date</h5>
31 Oct 2019




	    </div>
        </article>
    </div>
</div>

<!-- Footer -->
<footer class="uk-section uk-text-center uk-text-muted">
    <div class="uk-container uk-container-small">

	<!-- Site navigation links -->
        <div>
            <ul class="uk-subnav uk-flex-center">
                
            </ul>
        </div>
	<!-- Social Media Links -->
        <div class="uk-margin-medium">
            <div data-uk-grid class="uk-child-width-auto uk-grid-small uk-flex-center uk-grid">
                













            </div>
        </div>
	<!-- Copyright notice -->
        <div class="uk-margin-medium uk-text-small copyright link-secondary">
	    Copyright&copy; kb.pmem.io 2020. All rights reserved.
	    <!--  -->
	</div>

    </div>
</footer>
<!-- End of Footer -->





    <div id="offcanvas-docs" data-uk-offcanvas="overlay: true">
    <div class="uk-offcanvas-bar">

        <button class="uk-offcanvas-close" type="button" data-uk-close></button>

        
        <h5 class="uk-margin-top">Getting Started</h5>
        <ul class="uk-nav uk-nav-default doc-nav">
        
          
          
          <li class=""><a href="/docs/installation/">Theme installation</a></li>
        
          
          
          <li class=""><a href="/docs/setup/">Basic theme setup</a></li>
        
          
          
          <li class=""><a href="/docs/navigation/">Navigation bar</a></li>
        
          
          
          <li class=""><a href="/docs/footer/">Footer options</a></li>
        
          
          
          <li class=""><a href="/docs/posts/">Creating your first post in Jekyll</a></li>
        
          
          
          <li class=""><a href="/docs/docs/">Creating docs posts</a></li>
        
          
          
          <li class=""><a href="/docs/comments/">Enabling comments (via Disqus)</a></li>
        
          
          
          <li class=""><a href="/docs/analytics/">Google Analytics</a></li>
        
        </ul>
        
        <h5 class="uk-margin-top">Theme Features</h5>
        <ul class="uk-nav uk-nav-default doc-nav">
        
          
          
          <li class=""><a href="/docs/hero/">Hero page header</a></li>
        
          
          
          <li class=""><a href="/docs/boxes/">Category boxes section</a></li>
        
          
          
          <li class=""><a href="/docs/featured/">Fearured docs section</a></li>
        
          
          
          <li class=""><a href="/docs/videos/">Video lightbox boxes section</a></li>
        
          
          
          <li class=""><a href="/docs/faq/">Frequently asked questions section</a></li>
        
          
          
          <li class=""><a href="/docs/team/">Team members section</a></li>
        
          
          
          <li class=""><a href="/docs/cta/">Call to action section</a></li>
        
          
          
          <li class=""><a href="/docs/changelog/">Creating a changelog</a></li>
        
          
          
          <li class=""><a href="/docs/contact/">Contact form (via FormSpree)</a></li>
        
          
          
          <li class=""><a href="/docs/media/">Adding media to post and doc content</a></li>
        
          
          
          <li class=""><a href="/docs/toc/">Adding table of contents to docs</a></li>
        
          
          
          <li class=""><a href="/docs/alerts/">Adding alerts to content</a></li>
        
        </ul>
        
        <h5 class="uk-margin-top">Customization</h5>
        <ul class="uk-nav uk-nav-default doc-nav">
        
          
          
          <li class=""><a href="/docs/translation/">Translation</a></li>
        
          
          
          <li class=""><a href="/docs/customize/">Customization</a></li>
        
          
          
          <li class=""><a href="/docs/development/">Development</a></li>
        
          
          
          <li class=""><a href="/docs/sources/">Sources and credits</a></li>
        
        </ul>
        
        <h5 class="uk-margin-top">Help</h5>
        <ul class="uk-nav uk-nav-default doc-nav">
        
          
          
          <li class=""><a href="/docs/support/">Contacting support</a></li>
        
        </ul>
        

    </div>
</div>


    <div id="offcanvas" data-uk-offcanvas="flip: true; overlay: true">
    <div class="uk-offcanvas-bar">

        <a class="uk-logo uk-margin-small-bottom" href="/">kb.pmem.io</a>
     
        <button class="uk-offcanvas-close" type="button" data-uk-close></button>
      
        <ul class="uk-nav uk-nav-primary uk-margin-top">
            
                

                

                
                    <li><a href="/" >Home</a></li>
                
            
                

                

                
                    <li><a href="" >Knowledge Base</a></li>
                
            
                

                

                
                    <li><a href="https://docs.pmem.io/" target="_blank" >Docs</a></li>
                
            
                

                

                
                    <li><a href="https://pmem.io/blog/" target="_blank" >Blog</a></li>
                
            
        </ul>

        <div class="uk-margin-top uk-text-center">
            <div data-uk-grid class="uk-child-width-auto uk-grid-small uk-flex-center uk-grid">
                













            </div>
        </div>

    </div>
</div>


    

    
        
    

    

    </body>

</html>
